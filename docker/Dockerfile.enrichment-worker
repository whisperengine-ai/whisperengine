FROM python:3.11-slim

WORKDIR /app

# Install dependencies
COPY requirements-enrichment.txt .
RUN pip install --no-cache-dir -r requirements-enrichment.txt

# Download spaCy model for NLP preprocessing (90MB, better accuracy)
# This enables local entity extraction and reduces LLM token usage
RUN python -m spacy download en_core_web_md

# Copy only necessary source code for enrichment worker
COPY src/enrichment/ ./src/enrichment/
COPY src/llm/ ./src/llm/
COPY src/database/ ./src/database/
COPY src/utils/ ./src/utils/
COPY src/memory/ ./src/memory/
COPY src/temporal/ ./src/temporal/

# Create logs directory
RUN mkdir -p logs/enrichment

# Set Python path
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# Run enrichment worker
CMD ["python", "-m", "src.enrichment.worker"]
